<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Ripples Â· Ambient</title>
<style>
  html,body { margin:0; height:100%; background:#000; }
  .stage { position:fixed; inset:0; overflow:hidden; }
  .bg, .bg > * { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; }
  .bg { pointer-events:none; }
  canvas { position:absolute; inset:0; width:100%; height:100%; display:block; }

  #ui { position:fixed; inset:auto 0 0 auto; padding:12px; display:flex; gap:8px; align-items:center; }
  .btn {
    background:rgba(20,20,22,.5); color:#cfcfd4;
    border:1px solid rgba(255,255,255,.12);
    border-radius:6px; padding:.35rem .6rem;
    font:500 13px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    cursor:pointer; backdrop-filter:blur(6px);
    transition:background .2s ease, color .2s ease, opacity .2s ease;
    opacity:.9;
  }
  .btn:hover{ background:rgba(26,26,30,.62); color:#fff; opacity:1; }
  #badge {
    font:600 11px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color:#bbb; padding:.35rem .5rem; border-radius:6px;
    background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12);
  }
  #badge.on { color:#7fffb2; border-color:rgba(127,255,178,.35); }
  #credit {
    position:fixed;
    top:0.6rem;
    right:0.75rem;
    font:400 11px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color:rgba(255,255,255,0.35);
    letter-spacing:0.4px;
    pointer-events:none;
    user-select:none;
    z-index:1;
  }

  #instruction {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font: 500 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color: rgba(255, 255, 255, 0.9);
    letter-spacing: 0.4px;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 1.5s ease;
    z-index: 9999;
  }
</style>
</head>
<body>
<div class="stage">
  <div class="bg">
    <video id="bgVideo" muted playsinline loop preload="auto">
      <source src="/assets/videos/Landingloop.mp4" type="video/mp4">
    </video>
  </div>
  <canvas id="c"></canvas>
</div>

<div id="ui">
  <button id="modeSetBtn" class="btn">set: D-minorish</button>
  <button id="scaleBtn"   class="btn">scale: dorian</button>
  <button id="soundBtn"   class="btn">sound: enable</button>
  <div id="badge">AUDIO: OFF</div>
</div>

<script>
(() => {
  // ---------------- Visuals ----------------
  const video = document.getElementById('bgVideo');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  const COVER_ALPHA = 1.15, RING_COUNT = 4, RING_SPACING = 30,
        BASE_WIDTH = 2, LIFE_MS = 1000, SPEED = 220;

  const RING_GAIN = 1.8, EDGE_LIGHTNESS = 93, EDGE_SAT = 6,
        REVEAL_STRENGTH = 1.15, FADE_EXP = 1.6, RING_FALLOFF = 0.9;

  function edgeColor(alpha){ return `hsla(210, ${EDGE_SAT}%, ${EDGE_LIGHTNESS}%, ${alpha})`; }

  const SHADOW_ALPHA=0.16, SHADOW_BLUR=4, SHADOW_OFFSET_Y=1, SHADOW_WIDTH_SCALE=1.12;

  let dpr = window.devicePixelRatio || 1;
  function resize(){
    const w=innerWidth, h=innerHeight;
    canvas.width=Math.floor(w*dpr);
    canvas.height=Math.floor(h*dpr);
    canvas.style.width=w+'px'; canvas.style.height=h+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize, {passive:true}); resize();

  function tryPlay(){ const p=video.play?.(); if (p?.catch) p.catch(()=>{}); }
  video.addEventListener('canplay', tryPlay);
  addEventListener('pointerdown', tryPlay, {once:true, passive:true});
  tryPlay();

  const ripples = [];
  function addRipple(x, y, opts = {}) {
    ripples.push({
      x, y, t0: performance.now(),
      opacity: opts.opacity ?? (0.35 + Math.random() * 0.25),
      widthJitter: opts.widthJitter ?? (0.85 + Math.random() * 0.45),
      sizeMul: opts.sizeMul ?? (0.95 + Math.random() * 0.15),
      life: opts.life ?? LIFE_MS * (1.15 + Math.random() * 0.25),
      speed: opts.speed ?? SPEED * (0.9 + Math.random() * 0.15),
      depth: opts.depth ?? false
    });
  }

  function frame(now){
    ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
    ctx.fillStyle=`rgba(0,0,0,${COVER_ALPHA})`;
    ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);

    for (let i=ripples.length-1;i>=0;i--){
      const r=ripples[i], age=now-r.t0;
      if (age>r.life){ ripples.splice(i,1); continue; }
      const base=(age/1000)*r.speed;
      const life=1 - age/r.life;
      const fade=Math.pow(life,FADE_EXP);
      const baseAlpha=r.opacity*fade;
      const width=BASE_WIDTH*r.widthJitter*(1+0.4*Math.sin(age*0.004));

      for (let k=0;k<RING_COUNT;k++){
        const rad=(base+k*RING_SPACING)*r.sizeMul;
        if(rad<=0) continue;
        const ringGain=Math.pow(RING_FALLOFF,k);

        ctx.globalCompositeOperation='destination-out';
        ctx.strokeStyle=`rgba(0,0,0,${Math.min(1,fade*REVEAL_STRENGTH*ringGain).toFixed(3)})`;
        ctx.lineWidth=width;
        ctx.beginPath(); ctx.arc(r.x,r.y,rad,0,Math.PI*2); ctx.stroke();

        ctx.globalCompositeOperation='source-over';
        const edgeAlpha=baseAlpha*0.4*RING_GAIN*ringGain;
        ctx.strokeStyle=edgeColor(edgeAlpha.toFixed(3));
        ctx.lineWidth=width;
        ctx.beginPath(); ctx.arc(r.x,r.y,rad,0,Math.PI*2); ctx.stroke();
      }

      if(r.depth && baseAlpha>0.02){
        ctx.save();
        ctx.shadowBlur=SHADOW_BLUR;
        ctx.shadowColor=`rgba(0,0,0,${(SHADOW_ALPHA*life).toFixed(3)})`;
        ctx.shadowOffsetY=SHADOW_OFFSET_Y;
        ctx.strokeStyle='rgba(0,0,0,0)';
        ctx.lineWidth=width*SHADOW_WIDTH_SCALE;
        for(let k=0;k<RING_COUNT;k++){
          const rad=(base+k*RING_SPACING)*r.sizeMul; if(rad<=0) continue;
          ctx.beginPath(); ctx.arc(r.x,r.y,rad,0,Math.PI*2); ctx.stroke();
        }
        ctx.restore();
      }
    }
    ctx.globalCompositeOperation='source-over';
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  // --- Audio unlock handlers (kept simple for brevity) ---
  const soundBtn=document.getElementById('soundBtn');
  const badge=document.getElementById('badge');
  let audioCtx=null,audioBooted=false;
  function ensureAudioContext(){
    if(!audioCtx){const AudioCtx=window.AudioContext||window.webkitAudioContext; audioCtx=new AudioCtx();}
    return audioCtx;
  }
  async function bootAudioOnce(){
    ensureAudioContext(); if(audioBooted) return;
    try{ if(audioCtx.state!=='running') await audioCtx.resume();
      const silent=audioCtx.createBuffer(1,1,audioCtx.sampleRate);
      const src=audioCtx.createBufferSource(); src.buffer=silent; src.connect(audioCtx.destination); src.start(0);
      audioBooted=true; badge.textContent='AUDIO: ON'; badge.classList.add('on'); soundBtn.textContent='sound: enabled';
    }catch(e){console.warn('[ripple] audio unlock failed:',e);}
  }
  soundBtn.addEventListener('click',bootAudioOnce,{passive:true});
  addEventListener('pointerdown',bootAudioOnce,{once:true,passive:true});
})();
</script>

<div id="instruction">ðŸ”Š tap to begin Â· turn off silent mode for sound</div>
<div id="credit">v1 Â· zayn wiwchar</div>

<script>
  // Instruction fade-in/out
  window.addEventListener('load', () => {
    const instr = document.getElementById('instruction');
    if (!instr) return;
    instr.style.opacity = 1;
    setTimeout(() => instr.style.opacity = 0, 6000);
  });
</script>
</body>
</html>
